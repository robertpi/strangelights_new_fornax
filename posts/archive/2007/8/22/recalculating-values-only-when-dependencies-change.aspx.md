---
title: "Recalculating Values Only When Dependencies Change"
date: 2007-08-22T10:14:16.1270000
draft: false
---

<p class="MsoNormal" style="MARGIN: 0cm 0cm 10pt"><span lang="EN-GB"><font face="Calibri" size="3">I had an interesting exchange of emails with a reader recently. They wanted to be able to execute a function and cache the result and revaluate the function only when one of the values in depends on changes. It’s a common enough problem I guess, but one that’s surprisingly tricky to get right. This is because when you evaluate a function it’s difficult to know what it depends on and therefore difficult to know when the results of the evaluation become dirty.</font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 10pt"><span lang="EN-GB"><font face="Calibri" size="3">But between we came up with two different approaches to this problem. The first approach was to reuse idea of a lazy value, something already available in F# libraries but extend it to provide a reset function, which marks the value as dirty and forces it to be recalculated, we called this class ResetableLazy. We then couple this with UpdatableValue class a value that raises a notification each time that its value is changed. We then use these two types to create a function createDependentCal, which takes a list of UpdatableValue and associates it with a ResetableLazy calculation, that way each time one of the values in the list is changed the calculation is reset.</font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">#light<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">open</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> Microsoft.FSharp.Control.LazyStatus<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">/// a lazy value that can be reset to force it be recalculated<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">type</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> ResetableLazy&lt;'a&gt; = <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span>{ <span style="COLOR: blue">mutable</span> status : LazyStatus&lt;'a&gt;; initFunction : unit <span style="COLOR: blue">-&gt;</span> 'a }<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">type</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> ResetableLazy&lt;'a&gt; <span style="COLOR: blue">with<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">static</span> <span style="COLOR: blue">member</span> Create(f) : ResetableLazy&lt;'a&gt; = {status=(LazyStatus.Delayed f); initFunction = f}<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">member</span> x.IsForced = <span style="COLOR: blue">match</span> x.status <span style="COLOR: blue">with</span> LazyStatus.Value _ <span style="COLOR: blue">-&gt;</span> <span style="COLOR: blue">true</span> | _ <span style="COLOR: blue">-&gt;</span> <span style="COLOR: blue">false<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">member</span> x.IsDelayed = <span style="COLOR: blue">match</span> x.status <span style="COLOR: blue">with</span> LazyStatus.Delayed _ <span style="COLOR: blue">-&gt;</span> <span style="COLOR: blue">true</span> | _ <span style="COLOR: blue">-&gt;</span> <span style="COLOR: blue">false<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">member</span> x.IsException = <span style="COLOR: blue">match</span> x.status <span style="COLOR: blue">with</span> LazyStatus.Exception _ <span style="COLOR: blue">-&gt;</span> <span style="COLOR: blue">true</span> | _ <span style="COLOR: blue">-&gt;</span> <span style="COLOR: blue">false<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">member</span> x.Reset() = x.status &lt;- LazyStatus.Delayed x.initFunction<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">member</span> x.Force() = <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">match</span> x.status <span style="COLOR: blue">with</span> <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>| LazyStatus.Delayed f <span style="COLOR: blue">-&gt;</span> <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>x.status &lt;- Exception Undefined; <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span><span style="COLOR: blue">try</span> <span style="COLOR: blue">let</span> res = f () <span style="COLOR: blue">in</span> x.status &lt;- LazyStatus.Value res; res <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span><span style="COLOR: blue">with</span> e <span style="COLOR: blue">-&gt;</span> x.status &lt;- LazyStatus.Exception(e); rethrow()<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>| LazyStatus.Value x <span style="COLOR: blue">-&gt;</span> x<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>| LazyStatus.Exception e <span style="COLOR: blue">-&gt;</span> raise e<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">member</span> x.Value = x.Force()<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">/// a value that raise a notification when it is changed<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">type</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> UpdatableValue&lt;'a&gt;(origVal : 'a) = <span style="COLOR: blue">class<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">let</span> <span style="COLOR: blue">mutable</span> currentVal = origVal<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">let</span> changedTrigger, changedEvent = IEvent.create()<span style="mso-spacerun: yes">    </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">member</span> x.Changed<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">with</span> get() = changedEvent<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">member</span> x.Value<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">with</span> get() = currentVal<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">and</span> set newVal =<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">      </span><span style="mso-spacerun: yes">      </span>currentVal &lt;- newVal<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>changedTrigger()<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">end<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">/// a function that assoicated a list of UpdatableValue with a function<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">/// that that will be recalculated only when members of the list change<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">let</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> createDependentCal (dependencies : UpdatableValue&lt;_&gt; list)<span style="mso-spacerun: yes">  </span>f =<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">let</span> cal = ResetableLazy.Create(f)<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span>dependencies |&gt; List.iter (<span style="COLOR: blue">fun</span> x <span style="COLOR: blue">-&gt;</span> x.Changed.Add(<span style="COLOR: blue">fun</span> () <span style="COLOR: blue">-&gt;</span> cal.Reset()) )<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span>cal<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">// the tests ...<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">let</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> v1 = <span style="COLOR: blue">new</span> UpdatableValue&lt;int&gt;(1)<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">let</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> v2 = <span style="COLOR: blue">new</span> UpdatableValue&lt;int&gt;(2)<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">let</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> add10 = <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span>createDependentCal <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>[v1] <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>(<span style="COLOR: blue">fun</span> () <span style="COLOR: blue">-&gt;</span> <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>printfn <span style="COLOR: #a31515">"Executing: v1.Value + 10"<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>v1.Value + 10)<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">let</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> subV1V2 = <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span>createDependentCal <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>[v1; v2] <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>(<span style="COLOR: blue">fun</span> () <span style="COLOR: blue">-&gt;</span> <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">           </span>printfn <span style="COLOR: #a31515">"Executing: v1.Value - v2.Value"<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">           </span>v1.Value - v2.Value)<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">let</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> test() =<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">for</span> i = 0 <span style="COLOR: blue">to</span> 2 <span style="COLOR: blue">do</span> <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">      </span>Printf.printfn <span style="COLOR: #a31515">"iteration %d : result=%d"</span> i (add10.Force()) <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">      </span>Printf.printfn <span style="COLOR: #a31515">"iteration %d : result=%d"</span> i (subV1V2.Force()) <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">test()<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">Printf.printf <span style="COLOR: #a31515">"\nChanging v1 ...\n\n"</span> <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">v1.Value &lt;-<span style="mso-spacerun: yes">  </span>10<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">test()<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">  </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">Printf.printf <span style="COLOR: #a31515">"\nChanging v2 ...\n\n"</span> <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">v2.Value &lt;-<span style="mso-spacerun: yes">  </span>5<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">test()<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 10pt"><span lang="EN-GB" style="FONT-SIZE: 10pt; LINE-HEIGHT: 115%; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">read_line()</span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 10pt"><span lang="EN-GB"><font face="Calibri" size="3">The obvious limitation to this approach is the list of values must be explicitly associated with the calculation, so it’s possible that programmer could make a mistake and incorrectly use a value that had not been listed as depended.</font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 10pt"><span lang="EN-GB"><font face="Calibri" size="3">The second approach removes this limitation by automatically calculating dependencies. It does this because as each item, a value or a calculation, is fetched by a value property. As it is being fetched it pushes itself on to a stack so we can always find which calculation is calling us, allowing us to automatically build up a dependencies list.</font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">#light<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">open</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> System<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">open</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> System.Collections.Generic<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">/// A node in an evalution tree that can either be a caculation<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">/// or a value<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">type</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> Node&lt;'a&gt; = <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">| Value <span style="COLOR: blue">of</span> 'a<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">| Calculation <span style="COLOR: blue">of</span> (unit <span style="COLOR: blue">-&gt;</span> 'a)<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">/// A wrapper that allows the values of calculated nodes to be cached<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">type</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> NodeWrapper&lt;'a&gt; = <span style="COLOR: blue">class<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">val</span> stack: Stack&lt;NodeWrapper&lt;'a&gt;&gt;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">val</span> <span style="COLOR: blue">mutable</span> node: Node&lt;'a&gt;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">val</span> <span style="COLOR: blue">mutable</span> calculatedValue: option&lt;'a&gt;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">val</span> depencies: ResizeArray&lt;NodeWrapper&lt;'a&gt;&gt;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">new</span> (stack: Stack&lt;NodeWrapper&lt;'a&gt;&gt;, node: Node&lt;'a&gt;) = <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>{ stack = stack; <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">          </span>node = node; <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">       </span><span style="mso-spacerun: yes">   </span>calculatedValue = None; <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">          </span>depencies = <span style="COLOR: blue">new</span> ResizeArray&lt;NodeWrapper&lt;'a&gt;&gt;() }<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">member</span> x.Value<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">with</span> get() =<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span><span style="COLOR: green">// add the caller to the depencies list if one exists<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span><span style="COLOR: blue">if</span> x.stack.Count &gt; 0 <span style="COLOR: blue">then<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">                </span><span style="COLOR: blue">let</span> caller = x.stack.Peek()<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">                </span><span style="COLOR: blue">if</span> not (x.depencies.Exists(<span style="COLOR: blue">fun</span> x <span style="COLOR: blue">-&gt;</span> x = caller)) <span style="COLOR: blue">then</span> <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">                    </span>x.depencies.Add(caller)<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">                      </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span><span style="COLOR: blue">match</span> x.calculatedValue <span style="COLOR: blue">with<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>| None <span style="COLOR: blue">-&gt;<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">                </span><span style="COLOR: green">// push ourselves on to the caller stack so next user knows who we are<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">                </span>x.stack.Push(x)<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">                </span><span style="COLOR: green">// Evaluate ourself. <o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">                </span><span style="COLOR: blue">let</span> res = <span style="COLOR: blue">match</span> x.node <span style="COLOR: blue">with</span> Calculation f <span style="COLOR: blue">-&gt;</span> f() | Value x <span style="COLOR: blue">-&gt;</span> x<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">                </span><span style="COLOR: green">// remove ourselves from the call stack<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">                </span></span><span lang="FR" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes; mso-ansi-language: FR">x.stack.Pop() |&gt; ignore<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="FR" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes; mso-ansi-language: FR"><span style="mso-spacerun: yes">                </span><span style="COLOR: green">// update cache<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="FR" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes; mso-ansi-language: FR"><span style="mso-spacerun: yes">                </span></span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">x.calculatedValue &lt;- Some(res)<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">                </span>res<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>| Some x <span style="COLOR: blue">-&gt;</span> x <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">                    </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">and</span> set(v) = <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span><span style="COLOR: green">// update the node if its a value otherwise fail<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span><span style="COLOR: blue">match</span> v <span style="COLOR: blue">with<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>| Value _ <span style="COLOR: blue">-&gt;<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">                </span>x.node &lt;- v <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">                </span>x.calculatedValue &lt;- None<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">                </span>x.depencies |&gt; Seq.iter(<span style="COLOR: blue">fun</span> x <span style="COLOR: blue">-&gt;</span> x.MakeDirty() )<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>| Calculation _ <span style="COLOR: blue">-&gt;</span> failwith <span style="COLOR: #a31515">"can not reset the value of a calculation"<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">member</span> x.IsDirty <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">with</span> get() = <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span><span style="COLOR: blue">match</span> x.calculatedValue <span style="COLOR: blue">with</span> None <span style="COLOR: blue">-&gt;</span> <span style="COLOR: blue">true</span> | _ <span style="COLOR: blue">-&gt;</span> <span style="COLOR: blue">false<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">member</span> x.MakeDirty()= <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: green">// set us and our dependcies to dirty<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>x.calculatedValue &lt;- None<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>x.depencies |&gt; Seq.iter(<span style="COLOR: blue">fun</span> x <span style="COLOR: blue">-&gt;</span> x.MakeDirty() )<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">end<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">/// any node produced by this the same instance of this class will<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">/// automatically be related<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">type</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> StateWrapper&lt;'a&gt;() = <span style="COLOR: blue">class<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">let</span> stack = <span style="COLOR: blue">new</span> Stack&lt;NodeWrapper&lt;'a&gt;&gt;()<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">member</span> x.NewNode(n) = <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">new</span> NodeWrapper&lt;'a&gt;(stack, n)<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">end<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">// the tests ...<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">let</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> stateWrapper = <span style="COLOR: blue">new</span> StateWrapper&lt;int&gt;()<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">let</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> v1 = stateWrapper.NewNode(Value 1) <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">let</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> v2 = stateWrapper.NewNode(Value 2) <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">let</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> v3 = stateWrapper.NewNode(Value 3) <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">let</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> v4 = stateWrapper.NewNode(Value 4) <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><span style="mso-spacerun: yes">  </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">let</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> c1 = stateWrapper.NewNode(Calculation (<span style="COLOR: blue">fun</span>() <span style="COLOR: blue">-&gt;</span> Console.WriteLine <span style="COLOR: #a31515">"Calculating C1"</span>;<span style="mso-spacerun: yes">  </span>v1.Value + v2.Value)) <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">let</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> c2 = stateWrapper.NewNode(Calculation (<span style="COLOR: blue">fun</span>() <span style="COLOR: blue">-&gt;</span> Console.WriteLine <span style="COLOR: #a31515">"Calculating C2"</span>;<span style="mso-spacerun: yes">  </span>v3.Value + v4.Value)) <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">let</span><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"> c3 = stateWrapper.NewNode(Calculation (<span style="COLOR: blue">fun</span>() <span style="COLOR: blue">-&gt;</span> Console.WriteLine <span style="COLOR: #a31515">"Calculating C3"</span>;<span style="mso-spacerun: yes">  </span>c1.Value + c2.Value))<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes"><o:p> </o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">Console.WriteLine c1.Value <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">Console.WriteLine c3.Value <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">Console.WriteLine c3.Value<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">Console.WriteLine c3.Value<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">// Change values and verify. <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">v1.Value &lt;- Value 10 <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">v2.Value &lt;- Value 20 <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">v3.Value &lt;- Value 30 <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">v4.Value &lt;- Value 40 <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">Console.WriteLine c1.Value <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">Console.WriteLine c3.Value <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">Console.WriteLine c3.Value <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">Console.WriteLine c3.Value <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">// Set the value of function node, only c3 should recompute. <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">v3.Value &lt;- Value 666 <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">Console.WriteLine c1.Value <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">Console.WriteLine c3.Value <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">Console.WriteLine c3.Value <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">// Set an input of that function, check that c2, c3 recompute. <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">v3.Value &lt;- Value 300 <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">Console.WriteLine c3.Value <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; LINE-HEIGHT: normal; mso-layout-grid-align: none"><span lang="EN-GB" style="FONT-SIZE: 10pt; FONT-FAMILY: &quot;Courier New&quot;; mso-no-proof: yes">Console.WriteLine c3.Value <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 10pt"><span lang="EN-GB"><o:p><font face="Calibri" size="3"> </font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 10pt"><span lang="EN-GB"><font face="Calibri" size="3">We haven’t yet done anyway where near enough testing to root out any nasty corner cases, but I think both techniques show promise. </font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 10pt"><span lang="EN-GB"><font face="Calibri" size="3">There are several obvious problems to these approaches but most of these are probably acceptable to some degree. One problem is that neither approach works well with multithreading. If a value is updated by one thread while a calculation is being preformed then a calculation will become dirty and the thread performing the calculation won’t know until it’s too late. However we could probably live with this by group sets of related calculations on a single thread and running other unrelated calculation sets on different threads.</font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 10pt"><span lang="EN-GB"><font face="Calibri" size="3">Another problem is that both approaches add quite a bit of overhead to fetching values, so calculations must be sufficiently complicated to justify this over head, but there are probably many situations where this overhead is justifiable, particularly in the financially sector where I work. To ensure this approach is right we really need to design a test that uses a series of increasingly complicated calculations and varying rates of data change then use the two frameworks along with a control group to check there respective performance. Definitely an interesting study but for another blog post ...</font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 10pt"><span lang="EN-GB"><o:p><font face="Calibri" size="3"> </font></o:p></span></p>

### Feedback:

*Feedback was imported from my only blog engine, it's no longer possible to post feedback here.*

**re: Recalculating Values Only When Dependencies Change - [Geoffrey Washburn](http://existentialtype.net/)**

If you are not already aware of it, you may want to look at Umut Acar's work on selective memoization and self-adjusting computation (http://ttic.uchicago.edu/~umut/papers/index.html).

